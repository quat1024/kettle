<!DOCTYPE html>
<html><head><script id="bootstrap" type="text/javascript">//TODO: Bad data structure.

let cardsArray = [];

function getCard(id) {
  for(const card of cardsArray) {
    if(card.id === id) return card;
  }
  return undefined;
}

function updateOrAddCard(card) {
  for(let i = 0; i < cardsArray.length; i++) {
    if(cardsArray[i].id === card.id) {
      cardsArray[i] = card;
      return;
    }
  }
  cardsArray.push(card);
}

function callCard(id, ...args) {
  //todo: janky, will need to check this is the right scope, and stuff
  const card = getCard(id);
  return eval(`(${card["args"]}) => { ${card["text"]} }`)(...args);
}

class KettleCard extends HTMLElement {}
customElements.define("kettle-card", KettleCard);

class KettleProp extends HTMLElement {}
customElements.define("kettle-prop", KettleProp);

function cardToHtml(card) {
  const kvs = [];
  for(const prop in card) {
    if(prop === "id") continue;
    kvs.push("\n  ");
    kvs.push(h("kettle-prop", {"data-prop": prop}, card[prop]));
  }
  kvs.push("\n");
  const htm = h("kettle-card", {id: card.id}, kvs);
  return htm;
}

function htmlToCard(html) {
  const card = {};
  card.id = html.id;
  for(const child of Array.from(html.children)) {
    if(child instanceof KettleProp) {
      card[child.dataset.prop] = child.innerText;
    }
  }
  return card;
}

function makeCardViewer(card) {
  const htm = h("div", {},
    h("h2", {innerText: card.id}),
    card["args"] ? h("p", {}, "args: ", card["args"]) : [],
    card["text"] ? h("p", {}, "text: ", h("pre", {}, card["text"])) : [],
    h("button", {}, "Edit")
  );
  
  htm.querySelector("button").addEventListener("click", () => {
    const editor = makeCardEditor(card);
    htm.insertAdjacentElement("beforebegin", editor);
    htm.remove();
  });
  
  return htm;
}

function makeCardEditor(card) {
  const htm = h("div", {},
    h("input", {className: "id", type: "text", value: card.id}),
    h("br"),
    h("input", {className: "args", type: "text", value: card.args ? card.args : ""}),
    h("br"),
    h("textarea", {rows: 15, cols: 80}, card["text"]),
    h("button", {}, "Save")
  );

  const idField = htm.querySelector(".id");
  const argsField = htm.querySelector(".args");
  const textField = htm.querySelector("textarea");

  htm.querySelector("button").addEventListener("click", () => {
    const newCard = {
      id: idField.value,
      args: argsField.value,
      text: textField.value
    };
    updateOrAddCard(newCard);
    
    const viewer = makeCardViewer(newCard);
    htm.insertAdjacentElement("beforebegin", viewer);
    htm.remove();
  });
  
  return htm;
}

function recursiveAssign(target, src) {
  for(const key in src) {
    if(typeof src[key] == "object") {
      target[key] = target[key] || {};
      recursiveAssign(target[key], src[key]);
    } else target[key] = src[key];
  }
}

function h(elem, attrs, ...children) {
  attrs = attrs || {};

  let e = document.createElement(elem);
  recursiveAssign(e, attrs);
  for(const key of Object.keys(attrs)) {
    if(key.startsWith("data-")) {
      e.dataset[key.slice(5)] = attrs[key];
    }
  }
  children.flat(Infinity).forEach(child => {
    if(child instanceof HTMLElement) e.appendChild(child);
    else e.appendChild(document.createTextNode(child));
  });
  return e;
}

function quine() {
  const htm = h("html", {}, 
    h("head", {},
      h("script", {id: "bootstrap", type: "text/javascript"},
        document.getElementById("code").value.trim()
      )
    ),
    h("body", {},
      //Cheap hack to prevent card elements from showing thru
      h("div", {style: { display: "none" }},
        cardsArray.map(card => cardToHtml(card))
      ),
      h("textarea", {id: "code", rows: "40", cols: "80", spellcheck: "false"}),
      h("button", {id: "save"}, "Save"),
      h("button", {id: "iframe"}, "Iframe"),
      h("div", {id: "cards"})
    )
  );
  console.log(htm);
  console.log(htm.outerHtml);
  return "<!DOCTYPE html>\n" + htm.outerHTML;
}

function doSave() {
  let url = window.URL.createObjectURL(new Blob([quine()]));
  let a = h("a", {href: url, download: "kettle.html"});
  a.click();
  window.URL.revokeObjectURL(url);
}

function doIframe() {
  let bag = h("div", {},
    h("br"),
    h("iframe", {style: {width: "95vw", height: "95vh"}, srcdoc: quine()}),
    h("button", {}, "Close")
  );
  
  bag.querySelector("button").addEventListener("click", () => {
    if(confirm("Are you sure?")) bag.remove();
  });
  document.body.appendChild(bag);
}

function ready() {
  document.getElementById("code").value = document.getElementById("bootstrap").innerText;
  document.getElementById("save").addEventListener("click", doSave);
  document.getElementById("iframe").addEventListener("click", doIframe);

  updateOrAddCard({id: "test", args: "foo, bar", text: `
    console.log("hello from a freakin card");
    console.log("foo", foo);
    console.log("bar", bar);
    return 69;`});
  console.log(callCard("test", "fooarg", "bar arg"));
  
  //read all cards
  Array.from(document.querySelectorAll("kettle-card"))
    .map(htm => htmlToCard(htm))
    .forEach(card => updateOrAddCard(card));

  let target = document.querySelector("#cards");
  if(!target) {
    target = h("div", {id: "cards"});
    document.body.appendChild(target);
  }
  cardsArray.forEach(card => target.appendChild(makeCardViewer(card)));
}
document.addEventListener("DOMContentLoaded", ready);</script></head><body><div style="display: none;"><kettle-card id="test">
  <kettle-prop data-prop="args">foo, bar</kettle-prop>
  <kettle-prop data-prop="text">console.log(foo);</kettle-prop>
</kettle-card><kettle-card id="mycard">
  <kettle-prop data-prop="args"></kettle-prop>
  <kettle-prop data-prop="text">undefined</kettle-prop>
</kettle-card></div><textarea id="code" rows="40" cols="80" spellcheck="true"></textarea><button id="save">Save</button><button id="iframe">Iframe</button><div id="cards"></div></body></html>